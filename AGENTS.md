# Codex 系统提示词

## 1. 角色定位
- 技术架构师：从全局规划系统架构与演进路线，统筹关键技术决策。
- 全栈专家：熟悉前端、后端、数据库、运维、测试全链路，可跨层协作推动交付。
- 技术导师：清晰讲解思路、原理与方法，帮助开发者构建可迁移的知识体系。
- 技术伙伴：以协作姿态与用户共创方案，主动沟通状态与风险。
- 行业专家：关注行业最佳实践与趋势，提供具前瞻性的策略建议。

## 2. 核心工程原则（KISS / YAGNI / SOLID / DRY）
- **KISS 简单至上**：优先选择结构清晰、易读易测的方案，避免不必要的复杂度。
- **YAGNI 精益求精**：仅实现当前明确需求，明确推迟未来假设的功能预留。
- **SOLID 坚实基础**：坚持单一职责、开放封闭、里氏替换、接口隔离、依赖倒置五项原则，保持模块化与可扩展。
- **DRY 杜绝重复**：识别并消除重复逻辑，构建可复用的抽象以降低维护成本。
- 每次方案评估均需指出上述原则的应用或潜在违背，并给出调整建议。

## 3. 思维与方法论
- 系统性分析：先梳理整体架构、模块边界与依赖，再深入关键细节。
- 前瞻性思维：评估技术选型对性能、扩展性、成本与迭代节奏的长期影响。
- 风险评估：识别可靠性、安全性、性能与发布风险，提出预防与监测措施。
- 多角度考量：从技术、业务、用户体验、运维与治理等维度综合判断。
- 授人以渔：在结论外描述思路、原理、通用方法与学习路径。
- 提问引导：信息不足时先提问澄清，带动用户一起确认关键假设。

## 4. 默认工作流
1. 理解阶段：审阅资料/代码/需求，复盘现状、痛点与约束，标记原则应用点。
2. 规划阶段：确认目标、范围与衡量指标；列出可选方案并比较优缺点。
3. 执行阶段：拆解任务为可操作步骤，描述每步操作与对应工程原则落实。
4. 汇报阶段：总结产出、原则应用效果、遇到挑战与解决方案，以及下一步建议。

## 5. 交互与教学策略
- 每项需求至少提供两个可行方案，说明适用场景、优缺点与推荐顺序。
- 对复杂概念给出原理解析与常见误区，必要时附简要示意或伪代码。
- 关键决策需说明理由、替代方案与取舍过程。
- 若存在不确定性，需明确假设并询问用户确认。

## 6. 语言与输出规范
- 回复、注释与文档一律使用中文；引用英文专有名词时补充中文解释。
- 保持项目既有命名风格，必要时在中文注释中说明意图。
- 输出格式遵循仓库规范：命令、路径用反引号标注；多段代码使用 fenced code block。
- 审慎处理用户指令冲突或环境异常，先沟通再执行风险操作。

## 7. 工具使用规范（MCP）
### 7.1 通用策略
- 单轮仅调用一种 MCP 服务；需多工具时串行并说明衔接关系。
- 遵循最小必要原则：限定关键词、结果条数、时间窗口，减少噪声。
- 工具失败时记录原因，基于当前认知给出保守答案并标注不确定性，提示是否需要重试。
- 每次调用后在答复末尾附"工具调用简报"。

### 7.2 工具指引（基于当前服务状态）
- **context7**：用于官方文档/SDK/API 检索。流程：`resolve-library-id` 以锁定库 ID 与版本，随后 `get-library-docs`（可指定 topic 与 tokens）。引用时标注库 ID、版本与段落定位。
- **duckduckgo**：用于获取最新外部信息或官方公告。构造≤12 个关键词，结合 `site:`、`after:`、`filetype:` 等限定；返回 3-5 条高置信来源。
- **playwright**：用于网页交互验证、截图、表单测试。调用前确认不会触发敏感操作，输出需说明操作对象与预期结果。
- **sequential-thinking**：用于复杂任务拆解与路线图规划，输出 6-10 步、每步一句话、隐藏推理细节。调用前需先启用该服务。
- **serena**：用于代码语义检索、结构分析与符号级修改。推荐流程：`get_symbols_overview` → `find_symbol` → `find_referencing_symbols`，并限制 `relative_path` 以缩小搜索范围。
- **shrimp-task-manager**：用于任务/执行流管理（具体操作需与用户确认）。启用后方可调用，调用前请再次核实权限与预期产出。
- **zhipu-serach**：用于网络检索（支持中文语义）。建议配置精确关键词与时间窗口，确认数据来源可信后再引用。（优先使用webSearchBing）

### 7.3 错误处理与降级
- 429 限流：退避 20 秒并收窄查询范围。
- 5xx/超时：单次重试，退避 2 秒。
- 无结果：缩小或调整查询，并征询用户补充线索。
- 降级链路示例：Context7 → DuckDuckGo（限定官方域名）→ 请求用户信息 → 本地知识保守回答（标注不确定性）。

### 7.4 工具调用简报模板
> **工具调用简报**
> **工具**: <工具名称>
> **触发原因**: <调用原因>
> **输入摘要**: <关键参数/关键词>
> **结果概览**: <命中条数/库ID/主要来源/成功或失败>
> **时间**: <YYYY-MM-DD HH:MM>

## 8. 项目初始化清单
- 目录结构：列出主要目录与关键配置文件（如 `src/`、`apps/`、`packages/`、`config/`）。
- 依赖与脚本：梳理 `package.json`、`requirements.txt` 等文件的核心依赖与脚本说明。
- 构建与运行：记录启动/构建命令、必要环境变量、测试框架及入口。
- 数据与配置：确认配置文件、密钥管理方式，提醒敏感信息保护策略。
- 工程工具链：整理 CI/CD、格式化、Lint、静态分析、测试覆盖等实践。
- 首次调研建议输出：目录树概览、核心技术栈、关键模块、主要数据模型或 API。

## 9. 风险与异常处理
- 发现指令冲突、权限限制、仓库脏工作区或环境异常时立即暂停并向用户确认。
- 对潜在破坏性操作（删除、重置、强推等）必须事先征求明确授权。
- 若需求或背景存在歧义，先提出澄清问题并在回复中标明假设。
- 提醒用户关注潜在技术债、性能瓶颈或测试欠缺，并建议监控/验证步骤。

## 10. 编码与文件规范
- 新增或修改文件统一使用 UTF-8（无 BOM），若发现不同编码需转换并告知。
- 保持日志、错误信息原语言输出，必要时附中文解释，避免破坏现有格式。
- 代码注释使用中文，必要时在关键逻辑处添加简洁说明。


# Repository Guidelines

## 项目结构与模块组织
本仓库是纯静态 ES Module 应用：`index.html` 承载表单与渲染入口，`styles.css` 统一排版与配色。业务核心位于 `src/domain/`（如 `fireCalculator.js`、`taxation.js`），`src/data/` 负责解析表单并构建财务画像，`src/analytics/` 将投射结果整理为报告数据，`src/presentation/` 处理 DOM 事件与视图。`src/platform/` 预留平台整合适配层，`src/agents/` 则用于未来的自动化 Agent 协作逻辑。公共资产或示例数据应紧邻消费者模块存放，避免跨层耦合。

## 构建、测试与开发命令
- `python3 -m http.server 4173`：在仓库根目录启动本地静态服务，快速预览页面。
- `npx http-server . -c-1`：禁用缓存的静态服务器，方便验证样式与脚本更新。
- `npx prettier --check "src/**/*.js" styles.css`：校验代码格式，提交前可用 `--write` 自动修正。

## 代码风格与命名约定
JavaScript 采用 2 空格缩进、命名导出与 `const` 优先策略；函数与变量使用小驼峰，类使用帕斯卡命名，CSS class 保持短横线风格。复杂计算放在 `domain` 或 `analytics`，界面交互留在 `presentation`，每个文件力求聚焦单一职责。若涉及财务公式或税率，请在函数上方写简洁注释解释数据来源。

## 测试准则
推荐在 `tests/domain/`、`tests/analytics/` 中镜像源文件添加 `*.test.js`。使用 Node 20+ 的 `node --test tests` 运行全量用例，并记录预期收益/税额的断言。`FireCalculator`、`taxation`、`projectionReport` 需要保持 ≥80% 覆盖率，每次修复缺陷都添加回归测试。暂未引入浏览器自动化时，PR 描述中应列出手动验证步骤与关键 DOM 片段。

## 提交与 Pull Request 准则
历史记录以祈使句为主（示例：`domain: 重构复利推演`），建议格式为 `<scope>: <动作>`，scope 可取 `domain/data/analytics/presentation/docs`；正文 72 列换行并引用相关 Issue。PR 需说明动机、截图或 GIF（若 UI 变更）、本地运行的命令以及潜在风险，合并前再执行一次格式化与 `node --test` 以确保 CI 通过。

## 安全与配置提示
所有计算默认在浏览器本地完成，请勿在未脱敏的情况下持久化用户财务数据。新增平台集成时，把密钥放入 `.env.local` 并在代码中做能力检测，保证离线模式仍可回退。演示或教程示例请使用 `src/data/fixtures/` 下的合成数据，便于后续替换。




# 产品需求文档：FIRE 财务自由小程序 - V1.0

## 1\. 综述 (Overview)

### 1.1 项目背景与核心问题

市面上的记账工具大多停留在“记录花销”，缺乏高阶目标。本项目（FIRE 财务自由小程序）的核心是提供一个以“财务自由（FIRE）”为最终目标的个人财务健康与进度管理工具。

我们的核心价值主张 (USP) 是：**市面上的工具告诉你“钱花哪儿了”，而我们告诉你“你离‘不用上班’还有多远”。**

本PRD旨在定义产品V1.0的“新手引导”阶段，确保用户在首次使用时，能根据自身对FIRE理念的熟悉程度，顺畅地完成应用功能认知，并设定其核心的财务目标。

### 1.2 核心业务流程 / 用户旅程地图

(本文档将详细阐述阶段一)

1.  **阶段一：引导与 FIRE 目标设定 (Onboarding & Goal Setting)** - 首次进入小程序，根据自身 FIRE 认知水平（新手/老手），快速完成“终点”（FIRE 目标金额）的设定。
2.  **阶段二：初始资产盘点 (Initial Net Worth Audit)** - 录入当前所有的资产和负债，计算出自己的“起点”（当前净资产）。
3.  **阶段三：日常财务记录 (Daily Financial Logging)** - 在 Agent 协助下，高效记录收入（主动/被动）和支出（必要/品质）。
4.  **阶段四：核心仪表盘与进度审视 (Core Dashboard & Progress Review)** - 查看“FIRE 进度条”、储蓄率等，获得即时反馈。
5.  **阶段五：分析与模拟 (Analysis & Simulation)** - 获取深度报告，并使用“What-If 模拟器”探索路径。

## 2\. 用户故事详述 (User Stories)

### 阶段一：引导与 FIRE 目标设定 (Onboarding & Goal Setting)

-----

#### **US-01: 作为首次启动小程序的新用户，我希望被询问我对 FIRE 的熟悉程度，以便于系统能引导我进入最适合我的目标设定流程（是“手把手计算”还是“直接录入”）。**

  * **价值陈述 (Value Statement)**:
      * **作为** 首次启动小程序的新用户
      * **我希望** 被询问我对 FIRE 的熟悉程度
      * **以便于** 系统能引导我进入最适合我的目标设定流程（是“手把手计算”还是“直接录入”）。
  * **业务规则与逻辑 (Business Logic)**:
    1.  **前置条件**: 用户已完成微信授权登录，且本地（或后端）标记为“首次启动”（`is_new_user: true`）。
    2.  **操作流程 (Happy Path)**:
        1.  系统展示“欢迎分流页”（如线框图所示）。
        2.  **路径A (新手)**: 如果用户点击【我是 FIRE 新手】按钮。
        3.  **路径B (老手)**: 如果用户点击【我已了解 FIRE】按钮。
    3.  **异常处理 (Error Handling)**: (暂无明显异常路径，此页面为纯静态展示与导航)
  * **验收标准 (Acceptance Criteria)**:
      * **场景1: 新手路径**
          * **GIVEN** 用户是首次启动小程序并看到欢迎页
          * **WHEN** 用户点击【我是 FIRE 新手】按钮
          * **THEN** 系统应跳转至“FIRE 理念介绍页”（即 US-02）。
      * **场景2: 老手路径**
          * **GIVEN** 用户是首次启动小程序并看到欢迎页
          * **WHEN** 用户点击【我已了解 FIRE】按钮
          * **THEN** 系统应跳过“FIRE 理念介绍页”，直接进入“应用功能介绍”流程（即 US-03）。

-----

  * **技术实现概要 (Technical Implementation Brief)**:
      * **影响范围**: 小程序客户端。
      * **前端 / 客户端 (Frontend / Client)**: 这是一个静态页面 (View)。点击按钮后，更新本地（或全局）状态以标记用户的选择（如 `user_profile.fire_familiarity = 'novice'` 或 `'expert'`），并使用 `wx.navigateTo` 或 `wx.redirectTo` 跳转到相应页面。
      * **页面布局线框图 (ASCII Wireframe)**:
        ```text
        +------------------------------------------------------+
        |                                                      |
        |          [App Logo / 欢迎插图]                       |
        |                                                      |
        |            欢迎来到 [我们的小程序名称]               |
        |                                                      |
        |         一个助你实现财务自由(FIRE)的伙伴             |
        |                                                      |
        +------------------------------------------------------+
        |                                                      |
        |    为了给您最好的体验，请选择您的熟悉程度：          |
        |                                                      |
        |                                                      |
        |      +------------------------------------------+    |
        |      |                                          |    |
        |      |          我是 FIRE 新手                    |    |
        |      |        (带我从基础开始了解)              |    |
        |      |                                          |    |
        |      +------------------------------------------+    |
        |                                                      |
        |      +------------------------------------------+    |
        |      |                                          |    |
        |      |          我已了解 FIRE                     |    |
        |      |        (直接开始使用功能)                |    |
        |      |                                          |    |
        |      +------------------------------------------+    |
        |                                                      |
        +------------------------------------------------------+
        ```
      * **后端 (Backend)**: (此页面无后端 API 调用)
      * **数据库 / 存储 (Database / Storage)**: (无)
  * **数据模型 / 接口契约 (Data Contracts & APIs)**: (此页面无后端 API 调用)
  * **监控与运营 (Observability & Operations)**: (无)
  * **约束与边界 (Constraints & Boundaries)**: (无)
  * **非功能性需求 (Non-Functional)**: 页面加载需 \< 1s。
  * **开放问题与待确认事项 (Open Questions & Follow-ups)**:
    1.  [我们的小程序名称] 需要您（PO）来定一个。
    2.  [App Logo / 欢迎插图] 需要设计资源。

-----

#### **US-02: 作为一名 FIRE 新手，我希望在引导流程中看到一个简洁易懂的 FIRE 理念介绍，以便于我能理解这个小程序的核心目标（如 4% 法则、储蓄率的重要性）。**

  * **价值陈述 (Value Statement)**:
      * **作为** 一名 FIRE 新手
      * **我希望** 在引导流程中看到一个简洁易懂的 FIRE 理念介绍
      * **以便于** 我能理解这个小程序的核心目标（如 4% 法则、储蓄率的重要性）。
  * **业务规则与逻辑 (Business Logic)**:
    1.  **前置条件**: 用户在 US-01 页面点击了【我是 FIRE 新手】。
    2.  **操作流程 (Happy Path)**:
        1.  系统跳转到“什么是 FIRE？”介绍页面（如线框图所示）。
        2.  用户阅读此页面上的内容（内容本身待后续填充）。
        3.  用户滚动到底部，点击【我明白了，开始功能介绍】按钮。
    3.  **异常处理 (Error Handling)**:
          * 如果用户点击左上角的【\<- 返回】按钮，系统应将用户导航回 US-01（欢迎分流页）。
  * **验收标准 (Acceptance Criteria)**:
      * **场景1: 学习完毕，进入下一步**
          * **GIVEN** 用户正在查看“什么是 FIRE？”介绍页
          * **WHEN** 用户点击底部的【我明白了，开始功能介绍】按钮
          * **THEN** 系统应跳转至“应用功能介绍”流程（即 US-03）。
      * **场景2: 用户中途返回**
          * **GIVEN** 用户正在查看“什么是 FIRE？”介绍页
          * **WHEN** 用户点击左上角的【\<- 返回】按钮
          * **THEN** 系统应返回到 US-01（欢迎分流页）。

-----

  * **技术实现概要 (Technical Implementation Brief)**:
      * **影响范围**: 小程序客户端。
      * **前端 / 客户端 (Frontend / Client)**: 这是一个可滚动的静态内容视图（`View`）。内容（文本和图片）应易于配置（例如，V1.0 可硬编码，V2.0 考虑从 CMS 加载）。底部按钮触发 `wx.navigateTo`。
      * **页面布局线框图 (ASCII Wireframe)**:
        ```text
        +------------------------------------------------------+
        | [<- 返回]       什么是 FIRE？ (财务自由)         |
        +======================================================+
        |                                                      |
        |          [一个吸引人的 Banner 插图]                  |
        |                                                      |
        | ### 我们的核心目标：                                 |
        |                                                      |
        |   不再为了“必须”工作，而是为了“兴趣”工作。           |
        |                                                      |
        | ---                                                  |
        |                                                      |
        | ### 关键理念 1：4% 法则 (安全提现率)                 |
        |                                                      |
        |   [此处为图文说明... (内容后续填充)]                 |
        |   (解释：目标金额 = 每年支出 x 25)                   |
        |                                                      |
        | ---                                                  |
        |                                                      |
        | ### 关键理念 2：储蓄率 (最重要的指标)                |
        |                                                      |
        |   [此处为图文说明... (内容后续填充)]                 |
        |   (解释：储蓄率越高，达成 FIRE 越快)                 |
        |                                                      |
        |                                                      |
        |                                                      |
        |           +----------------------------+             |
        |           |                            |             |
        |           |    [ 我明白了，开始功能介绍 ]  |             |
        |           |                            |             |
        |           +----------------------------+             |
        |                                                      |
        +------------------------------------------------------+
        ```
      * **后端 (Backend)**: (此页面无后端 API 调用)
  * **数据模型 / 接口契约 (Data Contracts & APIs)**: (此页面无后端 API 调用)
  * **开放问题与待确认事项 (Open Questions & Follow-ups)**:
    1.  **[内容待定]**：FIRE 理念介绍的具体文案和插图，待您（作为 PO）后续提供。

-----

#### **US-03: 作为一名（已完成分流的）新用户，我希望通过一个快速的应用功能导览（覆盖5大模块），以便于我能理解小程序的核心功能布局，为后续设定目标和开始使用做准备。**

  * **价值陈述 (Value Statement)**:
      * **作为** 一名（已完成分流的）新用户
      * **我希望** 通过一个快速的应用功能导览（覆盖5大模块）
      * **以便于** 我能理解小程序的核心功能布局，为后续设定目标和开始使用做准备。
  * **业务规则与逻辑 (Business Logic)**:
    1.  **前置条件**: 用户从 US-01 (老手路径) 或 US-02 (新手路径) 导航而来。
    2.  **操作流程 (Happy Path)**:
        1.  系统展示一个 5 页的 `swiper` 组件（如线框图所示），默认在第 1 页。
        2.  用户可以向左滑动浏览 5 个模块的介绍。
        3.  当用户滑动到第 5/5 页时，出现【了解了，开始设定目标\!】按钮。
        4.  用户点击该按钮，进入下一个流程（设定 FIRE 目标）。
    3.  **异常处理 (Error Handling)**:
          * **跳过**: 用户在任何一页（1-4页）点击右上角的【跳过 \>】按钮，系统应立即结束导览，直接跳转到下一个流程（设定 FIRE 目标）。
          * **返回**: 此页面为单向 Onboarding 流程，不允许返回 US-01 或 US-02。
  * **验收标准 (Acceptance Criteria)**:
      * **场景1: 完整浏览并进入下一步**
          * **GIVEN** 用户正在浏览功能导览
          * **WHEN** 用户滑动到第 5/5 页，并点击【了解了，开始设定目标\!】按钮
          * **THEN** 系统应使用 `wx.redirectTo` 跳转至“FIRE 目标设定”页面（即 US-04）。
      * **场景2: 中途跳过**
          * **GIVEN** 用户正在浏览功能导览（例如第 2/5 页）
          * **WHEN** 用户点击右上角的【跳过 \>】按钮
          * **THEN** 系统应立即使用 `wx.redirectTo` 跳转至“FIRE 目标设定”页面（即 US-04）。

-----

  * **技术实现概要 (Technical Implementation Brief)**:
      * **影响范围**: 小程序客户端。
      * **前端 / 客户端 (Frontend / Client)**: 核心是使用小程序的 `swiper` 组件。`swiper-item` 包含每页的插图和介绍文字。需要监听 `swiper` 的 `change` 事件来更新底部的分页器（自定义实现或使用 `indicator-dots`）。【跳过】和【开始设定目标】按钮都触发 `wx.redirectTo` 到下一个页面，确保用户不会返回到引导页。
      * **页面布局线框图 (ASCII Wireframe)**:
        ```text
        (第 1/5 页：介绍支出填写)
        +------------------------------------------------------+
        |                                                      |
        |          [模块 1 插图：支出填写]                     |
        |                                                      |
        |           ### 1. 支出填写 (区分必要/品质)            |
        |                                                      |
        |      (简短介绍：例如 "我们帮您自动识别...")          |
        |                                                      |
        |                                                      |
        |                                        [跳过 >]      |
        |                                                      |
        |                   ( ● ○ ○ ○ ○ )                     |
        |                                                      |
        +------------------------------------------------------+

        (第 5/5 页：介绍 FIRE 分析)
        +------------------------------------------------------+
        |                                                      |
        |          [模块 5 插图：FIRE 分析]                      |
        |                                                      |
        |           ### 5. FIRE 分析与建议                     |
        |                                                      |
        |      (简短介绍：例如 "您的专属CFO...")               |
        |                                                      |
        |                                                      |
        |           +----------------------------+             |
        |           |                            |             |
        |           |    [ 了解了，开始设定目标! ]   |             |
        |           |                            |             |
        |           +----------------------------+             |
        |                                                      |
        |                   ( ○ ○ ○ ○ ● )                     |
        |                                                      |
        +------------------------------------------------------+
        ```
      * **后端 (Backend)**: (此页面无后端 API 调用)
  * **数据模型 / 接口契约 (Data Contracts & APIs)**: (此页面无后端 API 调用)
  * **开放问题与待确认事项 (Open Questions & Follow-ups)**:
    1.  **[内容待定]**：5 个模块介绍页各自的**插图**和**简短介绍文案**，待您（作为 PO）后续提供。

-----

#### **US-04: 作为已完成引导的新用户，我希望设定我的 FIRE 目标总金额，我既可以选择“使用向导（根据月支出）计算”，也可以选择“直接输入目标金额”，以便于小程序能准确记录我的最终财务目标。**

  * **价值陈述 (Value Statement)**:
      * **作为** 已完成引导的新用户
      * **我希望** 设定我的 FIRE 目标总金额，我既可以选择“使用向导（根据月支出）计算”，也可以选择“直接输入目标金额”
      * **以便于** 小程序能准确记录我的最终财务目标。
  * **业务规则与逻辑 (Business Logic)**:
    1.  **前置条件**: 用户从 US-03（功能导览）`redirectTo` 而来。
    2.  **页面状态**: 页面具有两种内部状态：“计算器模式”（默认）和“直接输入模式”。
    3.  **操作流程 (计算器模式 - Happy Path)**:
        1.  页面默认为“计算器模式”。
        2.  用户选择“每月支出”或“每年支出”（默认“每月”）。
        3.  用户在“输入金额”框中输入数字（例如 5000）。
        4.  系统**实时**在下方“估算的 FIRE 目标金额”区域显示结果。
        5.  **计算公式**:
              * 如果按月：`目标金额 = 输入金额 * 12 * 25`
              * 如果按年：`目标金额 = 输入金额 * 25`
        6.  用户点击【确认目标，开启旅程\!】。
    4.  **操作流程 (直接输入模式 - Happy Path)**:
        1.  用户点击“`[ 我是老手，直接输入目标金额... ]`”链接。
        2.  页面切换到“直接输入模式”。
        3.  用户在“请输入...目标总金额”框中输入数字（例如 1500000）。
        4.  用户点击【确认目标，开启旅程\!】。
    5.  **提交逻辑**: 无论使用哪种模式，点击【确认目标，开启旅程\!】按钮时，系统都会将最终的“目标金额”（无论是算出来的还是直接填的）通过 API 提交到后端，并标记“新手引导”流程已完成。
    6.  **异常处理 (Error Handling)**:
          * 输入框必须进行校验，只允许输入有效的正数（`type="digit"`）。
          * 如果输入为空或 0，【确认目标】按钮应为禁用状态（Disabled）。
          * 如果用户点击左上角的【\<- 返回 US-03】，应允许用户返回到功能导览页（*注：基于 US-03 使用 `redirectTo`，此返回按钮可能需隐藏或处理为退出小程序*）。**（待确认）**
  * **验收标准 (Acceptance Criteria)**:
      * **场景1: 默认计算器模式（按月）**
          * **GIVEN** 用户处于“计算器模式”并选择“每月支出”
          * **WHEN** 用户输入 `5000`
          * **THEN** 系统应实时显示“估算的 FIRE 目标金额 ≈ 1,500,000.00 元”。
      * **场景2: 计算器模式（按年）**
          * **GIVEN** 用户处于“计算器模式”并切换到“每年支出”
          * **WHEN** 用户输入 `60000`
          * **THEN** 系统应实时显示“估算的 FIRE 目标金额 ≈ 1,500,000.00 元”。
      * **场景3: 切换到直接输入**
          * **GIVEN** 用户处于“计算器模式”
          * **WHEN** 用户点击“`[ 我是老手... ]`”链接
          * **THEN** 页面应切换到“直接输入模式”，隐藏计算器相关选项。
      * **场景4: 成功提交目标**
          * **GIVEN** 用户已输入或计算出一个有效的目标金额（例如 1,500,000）
          * **WHEN** 用户点击【确认目标，开启旅程\!】
          * **THEN** 系统应调用 `POST /api/v1/user/fire-goal` 保存该目标金额，并使用 `wx.redirectTo` 跳转至「阶段二」的第一个页面（即 US-05: 初始资产盘点）。

-----

  * **技术实现概要 (Technical Implementation Brief)**:
      * **影响范围**: 小程序客户端；后端用户服务。
      * **前端 / 客户端 (Frontend / Client)**:
          * 使用 `data` 属性（例如 `mode: 'calculator' | 'direct'`）管理页面状态。
          * 使用 `wx:if` 来切换两种模式的 UI 显示。
          * “月/年”切换使用 `radio-group`。
          * 金额输入框 `input` 需绑定 `bindinput` 事件，实时调用计算函数并更新页面 `data`。
          * 提交按钮需调用 `POST /api/v1/user/fire-goal`。
          * 提交成功后，本地存储（`wx.setStorageSync`）标记 `onboarding_completed: true`，并使用 `wx.redirectTo` 跳转到新页面，防止用户返回引导流程。
      * **后端 (Backend)**:
          * 需要一个 `POST /api/v1/user/fire-goal` 接口，用于接收并存储用户的核心 FIRE 目标到用户档案表。
      * **页面布局线框图 (ASCII Wireframe)**:
        ```text
        (默认状态：计算器模式)
        +------------------------------------------------------+
        | [<- 返回 US-03]   设定你的 FIRE 目标                 |
        +======================================================+
        |                                                      |
        |   **方式一：让系统帮你算** (推荐)                  |
        |   (我们将根据 4% 法则为您估算)                       |
        |                                                      |
        |   1. 输入你 FIRE 后的...                             |
        |                                                      |
        |      [ (●) 每月 支出 ]  [ (○) 每年 支出 ]            |
        |                                                      |
        |   2. 输入金额 (仅包含"生存必要"支出)                 |
        |                                                      |
        |      ￥ [ 5000.00                   ]  [ ? ](提示)  |
        |                                                      |
        |   -------------------------------------------------- |
        |   **估算的 FIRE 目标金额 ≈ 1,500,000.00 元** |
        |   (计算公式: 5,000 * 12 * 25)                        |
        |   -------------------------------------------------- |
        |                                                      |
        |   [ 我是老手，直接输入目标金额... (点击切换) ]         |
        |                                                      |
        |           +----------------------------+             |
        |           |                            |             |
        |           |    [ 确认目标，开启旅程! ]     |             |
        |           |                            |             |
        |           +----------------------------+             |
        |                                                      |
        +------------------------------------------------------+

        (切换后：直接输入模式)
        +------------------------------------------------------+
        | [<- 返回 US-03]   设定你的 FIRE 目标                 |
        +======================================================+
        |                                                      |
        |   **方式二：直接输入你的目标** |
        |                                                      |
        |   请输入你已规划好的 FIRE 目标总金额                 |
        |                                                      |
        |                                                      |
        |      ￥ [ 1500000.00                ]                |
        |                                                      |
        |   -------------------------------------------------- |
        |                                                      |
        |   [ 切换回计算器模式... (点击切换) ]                   |
        |                                                      |
        |                                                      |
        |           +----------------------------+             |
        |           |                            |             |
        |           |    [ 确认目标，开启旅程! ]     |             |
        |           |                            |             |
        |           +----------------------------+             |
        |                                                      |
        +------------------------------------------------------+
        ```
  * **数据模型 / 接口契约 (Data Contracts & APIs)**:
      * `POST /api/v1/user/fire-goal`
      * **Request Body**:
        ```json
        {
          "target_amount": 1500000.00, // 最终确定的目标金额 (Number, > 0)
          "source_type": "calculator_monthly" // 来源: 'calculator_monthly', 'calculator_yearly', 'direct'
        }
        ```
      * **Response Body (Success)**: `200 OK`
        ```json
        {
          "status": "success",
          "user_id": "user-uuid-xxxx",
          "target_amount": 1500000.00
        }
        ```
      * **Response Body (Error)**: `400 BAD_REQUEST` (例如金额无效或 \< 0)
  * **非功能性需求 (Non-Functional)**: 计算器模式下的金额估算必须实时（\<100ms）反馈在 UI 上。

## Agent 架构规划（PC Web / 移动 H5）

### 全局统筹 Agent（Atlas Coordinator）
- **职责**：维护单一用户旅程状态机（覆盖 PRD 的引导 → 目标设定 → 资产盘点 → 记账 → 仪表盘 → 分析），在 PC Web 与移动 H5 间派发任务并做节奏控制。
- **输入**：`src/data/financialProfile.js` 生成的画像、域层计算结果（`FireCalculator`、`projectionReport`）、`localStorage/IndexedDB` 内的引导标记，以及即将上线的 API。
- **输出**：端侧事件（`onboarding:start`, `goal:set`, `projection:ready` 等）与域层任务清单；多端同时在线时负责仲裁优先级以防重复提交。
- **解耦策略**：Coordinator 仅维护依赖图与事件订阅，渲染、算法、存储代理均以插件方式注册，未来扩展小程序或桌面端时无需重写核心逻辑。

### PC Web 端 Agent
| Agent | 主要职责 | 依赖模块 | 输出/交付 |
| --- | --- | --- | --- |
| Onboarding Narrator Agent | 将 US-01~US-03 流程落成 PC 页面，完成用户分流、导览与跳转控制 | `src/presentation/main.js`, `src/presentation/viewToggles.js` | DOM 更新、`navigator:onboarding-complete` 事件 |
| Goal Calculator Agent | 实现 4% 法则计算、月/年支出换算与直接输入校验，复用 `FireCalculator`/`taxation` 规则 | `src/domain/fireCalculator.js`, `src/domain/taxation.js`, `src/data/financialProfile.js` | 目标金额模型（含来源标签） |
| Web Data Steward Agent | 负责 `POST /api/v1/user/fire-goal`、本地缓存、冲突检测与错误回退，保障 PC 操作与后端一致 | `src/platform/` API 包装层 | HTTP 结果、重试任务队列 |
| Insight Preview Agent | 调用 `src/analytics/projectionReport.js` 生成示意结果，辅助用户理解目标金额对收益影响 | `src/analytics/projectionReport.js`, `src/presentation/renderers.js` | 迷你仪表卡片、提示文案 |

### 移动 H5 端 Agent
| Agent | 主要职责 | 依赖模块 | 输出/交付 |
| --- | --- | --- | --- |
| H5 Shell Agent | 维护响应式布局、触控手势和资源按需加载，确保与 PC 共享代码又满足移动体验 | 复用 `src/presentation/`，追加 H5 样式与手势封装 | 响应式 UI、手势事件 |
| Flow Mirror Agent | 通过 Service Worker 或 BroadcastChannel 监听 Atlas 事件，保持多端旅程状态一致 | `src/platform/`（消息中枢） | 状态同步、冲突解决提示 |
| H5 Capture Agent | 提供离线草稿、震动/Toast 反馈及移动输入法友好的校验，为阶段二及之后的录入需求打底 | `src/data/`、`localStorage` | 待提交 payload、校验提示 |

### 协作要点与后续小程序承接
- Agent 间采用 `agent:<name>:event` 订阅约定，Atlas 维护注册表与依赖，便于新增/下线 Agent 时不影响其他角色。
- Web Data Steward 与 Flow Mirror 遵循“最后写入胜出 + 冲突提示”策略，Coordinator 负责告警，避免 FIRE 目标被覆盖。
- 小程序阶段将新增 `MiniApp Bridge Agent`（适配 `wx.*` API 与存储），复用 Goal Calculator 与 Data Steward 的核心逻辑，只需替换渲染与交互包裹层。

### 阶段一交付现状（Web/H5 共用）
- **Onboarding / 导览体验**：`index.html` + `src/agents/onboardingNarratorAgent.js` 已落地“欢迎 → 理念 → 功能速览”三段式 UI，Hero 区加入 01-05 步骤导航，Atlas Coordinator 负责视图切换并输出 `onboarding:path` 事件，可直接接入埋点。
- **FIRE 目标估算**：`goalCalculatorAgent` 支持月/年向导与直接输入，并通过 `goal:preview`／`goal:spending` 事件将目标金额与年度支出回填到试算表单。目标概览卡片放在中列，CTA 固定在 `.goal-cta`（最右列）中，满足“概览居中、按钮置右”的 UX 诉求。
- **模拟试算**：`FireCalculator`、`financialProfile`、`createProjectionReport`、`renderers` 已引入通货膨胀率（CPI）参数，每年都会按“期初存款 × CPI”扣减购买力并在表格中展示“CPI 扣减”列；同时保留年使用金额列方便比对。填写区域与结果表按 0.85/1.15 比例布局，表格可显示更多列。
- **响应式与数据同步**：`styles.css` 切换为浅蓝主题，`goal-grid` 采用三列栅格（估算面板/概览/CTA），H5 Shell Agent 根据 viewport 切换 `app-shell.is-mobile`。Flow Mirror Agent 将旅程状态写入 `sessionStorage`，H5 Capture Agent 提供离线草稿，确保 PC/H5 双端衔接。
- **后续建议**：Atlas 可记录 CPI、目标金额等关键信号（`timeline`），留作多 Agent 决策依据；实现真实 `POST /api/v1/user/fire-goal` 后，Web Data Steward 需换成实际 API 调用并扩展冲突提示；当阶段二启动时，可新增 Asset Intake Agent，与 Flow Mirror 协同同步资产草稿。
